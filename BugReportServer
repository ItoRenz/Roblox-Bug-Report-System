-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  PROFESSIONAL ISSUE TRACKING SYSTEM - SERVER MODULE
--  Enterprise-Grade Discord Integration with Advanced Security
--  
--  Author: ItoRenz00
--  Version: 1.0.0
--  Last Updated: 2025
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIGURATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local CONFIG = {
    WEBHOOK_URL = "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN",
    COOLDOWN = 90,              -- Seconds between reports per user
    MIN_LENGTH = 15,            -- Minimum characters
    MAX_LENGTH = 750,           -- Maximum characters
    RATE_LIMIT = 10,            -- Max reports per hour globally
    EMBED_COLOR = 0x8A2BE2      -- Premium Purple
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local userCooldowns = {}
local hourlyReports = 0
local lastHourReset = os.time()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REMOTE EVENT SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local sendBugReport = Instance.new("RemoteEvent")
sendBugReport.Name = "SendBugReport"
sendBugReport.Parent = ReplicatedStorage

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UTILITY FUNCTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Sanitize text input
local function sanitizeText(text)
    if type(text) ~= "string" then return nil end
    
    -- Remove excessive whitespace
    text = text:gsub("%s+", " ")
    text = text:match("^%s*(.-)%s*$")
    
    return text
end

-- Check for spam patterns
local function isSpamContent(text)
    local lowerText = string.lower(text)
    
    local spamPatterns = {
        "^(.+)%1%1%1",           -- Repeated characters (aaaa, testtest)
        "^test+$",                -- Just "test"
        "^spam+$",                -- Just "spam"
        "^%.+$",                  -- Just dots
        "^%d+$"                   -- Just numbers
    }
    
    for _, pattern in ipairs(spamPatterns) do
        if string.match(lowerText, pattern) then
            return true
        end
    end
    
    return false
end

-- Format Discord timestamp
local function getDiscordTimestamp()
    return os.date("!%Y-%m-%dT%H:%M:%SZ")
end

-- Get player information
local function getPlayerInfo(player)
    local accountAge = player.AccountAge
    local membershipType = player.MembershipType.Name
    
    return {
        name = player.Name,
        displayName = player.DisplayName,
        userId = player.UserId,
        accountAge = accountAge .. " days",
        membership = membershipType,
        locale = player.LocaleId or "Unknown"
    }
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DISCORD INTEGRATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function sendToDiscord(playerInfo, reportText)
    -- Create premium embed
    local embed = {
        ["title"] = "âš¡ NEW ISSUE REPORT",
        ["description"] = "A player has submitted a bug report",
        ["color"] = CONFIG.EMBED_COLOR,
        ["fields"] = {
            {
                ["name"] = "ğŸ‘¤ Player Information",
                ["value"] = string.format(
                    "**Name:** %s (@%s)\n**User ID:** `%d`\n**Account Age:** %s\n**Membership:** %s",
                    playerInfo.displayName,
                    playerInfo.name,
                    playerInfo.userId,
                    playerInfo.accountAge,
                    playerInfo.membership
                ),
                ["inline"] = false
            },
            {
                ["name"] = "ğŸ“‹ Issue Description",
                ["value"] = "```" .. reportText .. "```",
                ["inline"] = false
            },
            {
                ["name"] = "ğŸŒ Locale",
                ["value"] = playerInfo.locale,
                ["inline"] = true
            },
            {
                ["name"] = "ğŸ• Reported At",
                ["value"] = string.format("<t:%d:F>", os.time()),
                ["inline"] = true
            }
        },
        ["footer"] = {
            ["text"] = "Professional Issue Tracking System â€¢ Powered by Roblox",
            ["icon_url"] = "https://cdn.discordapp.com/emojis/YOUR_EMOJI_ID.png"
        },
        ["timestamp"] = getDiscordTimestamp(),
        ["thumbnail"] = {
            ["url"] = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=150&height=150&format=png", playerInfo.userId)
        }
    }
    
    -- Add separator line
    local separatorEmbed = {
        ["description"] = "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ["color"] = CONFIG.EMBED_COLOR
    }
    
    local data = {
        ["username"] = "Bug Report System",
        ["avatar_url"] = "https://cdn.discordapp.com/emojis/YOUR_AVATAR_EMOJI.png",
        ["embeds"] = {embed}
    }
    
    -- Send request
    local success, response = pcall(function()
        return HttpService:PostAsync(
            CONFIG.WEBHOOK_URL,
            HttpService:JSONEncode(data),
            Enum.HttpContentType.ApplicationJson,
            false
        )
    end)
    
    return success, response
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COOLDOWN MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function checkCooldown(userId)
    local currentTime = tick()
    
    if userCooldowns[userId] then
        local timeElapsed = currentTime - userCooldowns[userId]
        local timeLeft = CONFIG.COOLDOWN - timeElapsed
        
        if timeLeft > 0 then
            return false, math.ceil(timeLeft)
        end
    end
    
    return true, 0
end

local function setCooldown(userId)
    userCooldowns[userId] = tick()
    
    -- Auto cleanup after cooldown expires
    task.delay(CONFIG.COOLDOWN, function()
        if userCooldowns[userId] then
            userCooldowns[userId] = nil
        end
    end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RATE LIMITING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function checkRateLimit()
    local currentTime = os.time()
    
    -- Reset hourly counter
    if currentTime - lastHourReset >= 3600 then
        hourlyReports = 0
        lastHourReset = currentTime
    end
    
    if hourlyReports >= CONFIG.RATE_LIMIT then
        return false
    end
    
    hourlyReports = hourlyReports + 1
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VALIDATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function validateReport(player, reportText)
    -- Type validation
    if type(reportText) ~= "string" then
        return false, "Invalid data type"
    end
    
    -- Sanitize
    reportText = sanitizeText(reportText)
    if not reportText then
        return false, "Invalid content"
    end
    
    -- Length validation
    local length = #reportText
    if length < CONFIG.MIN_LENGTH then
        return false, string.format("Report too short (min: %d chars)", CONFIG.MIN_LENGTH)
    end
    
    if length > CONFIG.MAX_LENGTH then
        return false, string.format("Report too long (max: %d chars)", CONFIG.MAX_LENGTH)
    end
    
    -- Spam detection
    if isSpamContent(reportText) then
        return false, "Spam content detected"
    end
    
    -- Cooldown check
    local canReport, timeLeft = checkCooldown(player.UserId)
    if not canReport then
        return false, string.format("Cooldown active (%ds remaining)", timeLeft)
    end
    
    -- Rate limit check
    if not checkRateLimit() then
        return false, "Global rate limit reached"
    end
    
    return true, reportText
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN EVENT HANDLER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sendBugReport.OnServerEvent:Connect(function(player, reportText)
    -- Initial checks
    if not player or not player.Parent then
        return
    end
    
    -- Validate report
    local isValid, result = validateReport(player, reportText)
    
    if not isValid then
        warn(string.format("[BUG REPORT] âŒ Rejected from %s: %s", player.Name, result))
        return
    end
    
    -- Get player information
    local playerInfo = getPlayerInfo(player)
    
    -- Send to Discord
    local success, response = sendToDiscord(playerInfo, result)
    
    if success then
        print(string.format("[BUG REPORT] âœ… Report from %s sent successfully", player.Name))
        
        -- Set cooldown
        setCooldown(player.UserId)
        
        -- Log to analytics (optional)
        -- AnalyticsService:FireEvent("BugReportSubmitted", player.UserId)
    else
        warn(string.format("[BUG REPORT] âŒ Discord webhook failed: %s", tostring(response)))
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLEANUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Players.PlayerRemoving:Connect(function(player)
    -- Remove cooldown when player leaves
    if userCooldowns[player.UserId] then
        userCooldowns[player.UserId] = nil
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INITIALIZATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ“ Professional Issue Tracking System Active")
print("Author: ItoRenz")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("ğŸ“Š Configuration:")
print("  â€¢ Cooldown: " .. CONFIG.COOLDOWN .. "s per user")
print("  â€¢ Rate Limit: " .. CONFIG.RATE_LIMIT .. " reports/hour")
print("  â€¢ Length: " .. CONFIG.MIN_LENGTH .. "-" .. CONFIG.MAX_LENGTH .. " chars")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- Check if HTTP is enabled
if not pcall(function() HttpService:GetAsync("https://httpbin.org/get") end) then
    warn("âš ï¸  WARNING: HTTP Requests are DISABLED!")
    warn("âš ï¸  Enable in Game Settings â†’ Security â†’ Allow HTTP Requests")
end
