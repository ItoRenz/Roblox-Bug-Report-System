-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  PROFESSIONAL ISSUE TRACKING SYSTEM - SERVER MODULE
--  Enterprise-Grade Discord Integration with Advanced Security
--  + PLAYER REPORT SYSTEM
--  
--  Author: ItoRenz00
--  Version: 2.1.0
--  Last Updated: 2025
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIGURATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local CONFIG = {
    WEBHOOK_URL_BUG = "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN",
    WEBHOOK_URL_PLAYER = "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN",
    COOLDOWN = 90,
    MIN_LENGTH_BUG = 10,
    MAX_LENGTH_BUG = 750,
    MIN_LENGTH_PLAYER = 5,
    MAX_LENGTH_PLAYER = 500,
    RATE_LIMIT = 10,
    EMBED_COLOR_BUG = 0x8A2BE2,
    EMBED_COLOR_PLAYER = 0xFF4500
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local userCooldowns = {}
local hourlyReports = 0
local lastHourReset = os.time()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REMOTE EVENT SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local sendBugReport = ReplicatedStorage:FindFirstChild("SendBugReport")
if not sendBugReport then
    sendBugReport = Instance.new("RemoteEvent")
    sendBugReport.Name = "SendBugReport"
    sendBugReport.Parent = ReplicatedStorage
end

local sendPlayerReport = ReplicatedStorage:FindFirstChild("SendPlayerReport")
if not sendPlayerReport then
    sendPlayerReport = Instance.new("RemoteEvent")
    sendPlayerReport.Name = "SendPlayerReport"
    sendPlayerReport.Parent = ReplicatedStorage
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UTILITY FUNCTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function sanitizeText(text)
    if type(text) ~= "string" then return nil end
    text = text:gsub("%s+", " ")
    text = text:match("^%s*(.-)%s*$")
    return text
end

local function isSpamContent(text)
    local lowerText = string.lower(text)
    local spamPatterns = {
        "^(.+)%1%1%1",
        "^test+$",
        "^spam+$",
        "^%.+$",
        "^%d+$"
    }
    for _, pattern in ipairs(spamPatterns) do
        if string.match(lowerText, pattern) then
            return true
        end
    end
    return false
end

local function getDiscordTimestamp()
    return os.date("!%Y-%m-%dT%H:%M:%SZ")
end

local function getPlayerInfo(player)
    return {
        name = player.Name,
        displayName = player.DisplayName,
        userId = player.UserId,
        accountAge = player.AccountAge .. " days",
        membership = player.MembershipType.Name,
        locale = player.LocaleId or "Unknown"
    }
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DISCORD INTEGRATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function sendBugReportToDiscord(playerInfo, reportText)
    local embed = {
        ["title"] = "ğŸ› NEW BUG REPORT",
        ["description"] = "A player has submitted a bug report",
        ["color"] = CONFIG.EMBED_COLOR_BUG,
        ["fields"] = {
            {
                ["name"] = "ğŸ‘¤ Reporter Information",
                ["value"] = string.format(
                    "**Name:** %s (@%s)\n**User ID:** `%d`\n**Account Age:** %s\n**Membership:** %s",
                    playerInfo.displayName,
                    playerInfo.name,
                    playerInfo.userId,
                    playerInfo.accountAge,
                    playerInfo.membership
                ),
                ["inline"] = false
            },
            {
                ["name"] = "ğŸ“‹ Issue Description",
                ["value"] = "``````",
                ["inline"] = false
            },
            {
                ["name"] = "ğŸŒ Locale",
                ["value"] = playerInfo.locale,
                ["inline"] = true
            },
            {
                ["name"] = "ğŸ• Reported At",
                ["value"] = string.format("<t:%d:F>", os.time()),
                ["inline"] = true
            }
        },
        ["footer"] = {
            ["text"] = "Professional Issue Tracking System â€¢ Bug Report"
        },
        ["timestamp"] = getDiscordTimestamp(),
        ["thumbnail"] = {
            ["url"] = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=150&height=150&format=png", playerInfo.userId)
        }
    }
    
    local data = {
        ["username"] = "Bug Report System",
        ["embeds"] = {embed}
    }
    
    local success, response = pcall(function()
        return HttpService:PostAsync(
            CONFIG.WEBHOOK_URL_BUG,
            HttpService:JSONEncode(data),
            Enum.HttpContentType.ApplicationJson,
            false
        )
    end)
    
    return success, response
end

local function sendPlayerReportToDiscord(reporterInfo, reportedUserId, reportedPlayerName, reason)
    local embed = {
        ["title"] = "ğŸ‘¤ NEW PLAYER REPORT",
        ["description"] = "A player has been reported",
        ["color"] = CONFIG.EMBED_COLOR_PLAYER,
        ["fields"] = {
            {
                ["name"] = "ğŸ‘® Reporter Information",
                ["value"] = string.format(
                    "**Name:** %s (@%s)\n**User ID:** `%d`\n**Account Age:** %s",
                    reporterInfo.displayName,
                    reporterInfo.name,
                    reporterInfo.userId,
                    reporterInfo.accountAge
                ),
                ["inline"] = false
            },
            {
                ["name"] = "ğŸ¯ Reported Player",
                ["value"] = string.format(
                    "**Name:** @%s\n**User ID:** `%d`\n[View Profile](https://www.roblox.com/users/%d/profile)",
                    reportedPlayerName,
                    reportedUserId,
                    reportedUserId
                ),
                ["inline"] = false
            },
            {
                ["name"] = "ğŸ“ Reason",
                ["value"] = "``````",
                ["inline"] = false
            },
            {
                ["name"] = "ğŸ• Reported At",
                ["value"] = string.format("<t:%d:F>", os.time()),
                ["inline"] = true
            },
            {
                ["name"] = "ğŸ® Server ID",
                ["value"] = "`" .. game.JobId .. "`",
                ["inline"] = true
            }
        },
        ["footer"] = {
            ["text"] = "Professional Issue Tracking System â€¢ Player Report"
        },
        ["timestamp"] = getDiscordTimestamp(),
        ["thumbnail"] = {
            ["url"] = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=150&height=150&format=png", reportedUserId)
        }
    }
    
    local data = {
        ["username"] = "Player Report System",
        ["embeds"] = {embed}
    }
    
    local success, response = pcall(function()
        return HttpService:PostAsync(
            CONFIG.WEBHOOK_URL_PLAYER,
            HttpService:JSONEncode(data),
            Enum.HttpContentType.ApplicationJson,
            false
        )
    end)
    
    return success, response
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COOLDOWN MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function checkCooldown(userId)
    local currentTime = tick()
    if userCooldowns[userId] then
        local timeElapsed = currentTime - userCooldowns[userId]
        local timeLeft = CONFIG.COOLDOWN - timeElapsed
        if timeLeft > 0 then
            return false, math.ceil(timeLeft)
        end
    end
    return true, 0
end

local function setCooldown(userId)
    userCooldowns[userId] = tick()
    task.delay(CONFIG.COOLDOWN, function()
        if userCooldowns[userId] then
            userCooldowns[userId] = nil
        end
    end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RATE LIMITING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function checkRateLimit()
    local currentTime = os.time()
    if currentTime - lastHourReset >= 3600 then
        hourlyReports = 0
        lastHourReset = currentTime
    end
    if hourlyReports >= CONFIG.RATE_LIMIT then
        return false
    end
    hourlyReports = hourlyReports + 1
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VALIDATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function validateBugReport(player, reportText)
    if type(reportText) ~= "string" then
        return false, "Invalid data type"
    end
    reportText = sanitizeText(reportText)
    if not reportText then
        return false, "Invalid content"
    end
    local length = #reportText
    if length < CONFIG.MIN_LENGTH_BUG then
        return false, string.format("Report too short (min: %d chars)", CONFIG.MIN_LENGTH_BUG)
    end
    if length > CONFIG.MAX_LENGTH_BUG then
        return false, string.format("Report too long (max: %d chars)", CONFIG.MAX_LENGTH_BUG)
    end
    if isSpamContent(reportText) then
        return false, "Spam content detected"
    end
    local canReport, timeLeft = checkCooldown(player.UserId)
    if not canReport then
        return false, string.format("Cooldown active (%ds remaining)", timeLeft)
    end
    if not checkRateLimit() then
        return false, "Global rate limit reached"
    end
    return true, reportText
end

local function validatePlayerReport(player, reportedUserId, reportedPlayerName, reason)
    if type(reportedUserId) ~= "number" or type(reportedPlayerName) ~= "string" or type(reason) ~= "string" then
        return false, "Invalid data types"
    end
    if reportedUserId == player.UserId then
        return false, "Cannot report yourself"
    end
    reason = sanitizeText(reason)
    if not reason then
        return false, "Invalid content"
    end
    local length = #reason
    if length < CONFIG.MIN_LENGTH_PLAYER then
        return false, string.format("Reason too short (min: %d chars)", CONFIG.MIN_LENGTH_PLAYER)
    end
    if length > CONFIG.MAX_LENGTH_PLAYER then
        return false, string.format("Reason too long (max: %d chars)", CONFIG.MAX_LENGTH_PLAYER)
    end
    if isSpamContent(reason) then
        return false, "Spam content detected"
    end
    local canReport, timeLeft = checkCooldown(player.UserId)
    if not canReport then
        return false, string.format("Cooldown active (%ds remaining)", timeLeft)
    end
    if not checkRateLimit() then
        return false, "Global rate limit reached"
    end
    return true, reason
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN EVENT HANDLERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sendBugReport.OnServerEvent:Connect(function(player, reportText)
    if not player or not player.Parent then return end
    local isValid, result = validateBugReport(player, reportText)
    if not isValid then
        warn(string.format("[BUG REPORT] âŒ Rejected from %s: %s", player.Name, result))
        return
    end
    local playerInfo = getPlayerInfo(player)
    local success, response = sendBugReportToDiscord(playerInfo, result)
    if success then
        print(string.format("[BUG REPORT] âœ… Report from %s sent successfully", player.Name))
        setCooldown(player.UserId)
    else
        warn(string.format("[BUG REPORT] âŒ Discord webhook failed: %s", tostring(response)))
    end
end)

sendPlayerReport.OnServerEvent:Connect(function(player, reportedUserId, reportedPlayerName, reason)
    if not player or not player.Parent then return end
    local isValid, sanitizedReason = validatePlayerReport(player, reportedUserId, reportedPlayerName, reason)
    if not isValid then
        warn(string.format("[PLAYER REPORT] âŒ Rejected from %s: %s", player.Name, sanitizedReason))
        return
    end
    local reporterInfo = getPlayerInfo(player)
    local success, response = sendPlayerReportToDiscord(reporterInfo, reportedUserId, reportedPlayerName, sanitizedReason)
    if success then
        print(string.format("[PLAYER REPORT] âœ… Report from %s against %s sent successfully", player.Name, reportedPlayerName))
        setCooldown(player.UserId)
    else
        warn(string.format("[PLAYER REPORT] âŒ Discord webhook failed: %s", tostring(response)))
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLEANUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Players.PlayerRemoving:Connect(function(player)
    if userCooldowns[player.UserId] then
        userCooldowns[player.UserId] = nil
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INITIALIZATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ“ Professional Issue Tracking System Active v2.1")
print("Author: ItoRenz00")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("ğŸ“Š Configuration:")
print("  â€¢ Cooldown: " .. CONFIG.COOLDOWN .. "s per user")
print("  â€¢ Rate Limit: " .. CONFIG.RATE_LIMIT .. " reports/hour")
print("  â€¢ Bug Report Length: " .. CONFIG.MIN_LENGTH_BUG .. "-" .. CONFIG.MAX_LENGTH_BUG .. " chars")
print("  â€¢ Player Report Length: " .. CONFIG.MIN_LENGTH_PLAYER .. "-" .. CONFIG.MAX_LENGTH_PLAYER .. " chars")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("Features: Bug Report + Player Report")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

if not pcall(function() HttpService:GetAsync("https://httpbin.org/get") end) then
    warn("âš ï¸  WARNING: HTTP Requests are DISABLED!")
    warn("âš ï¸  Enable in Game Settings â†’ Security â†’ Allow HTTP Requests")
end
